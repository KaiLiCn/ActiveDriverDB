{% extends "base.html" %}

{% block title %}
    {{ protein.gene.name }} - {{ protein.refseq }} - network view - {{ super() }}
{% endblock %}

{% block head %}
  {{ super() }}

  {% assets "css_network" %}
    <link rel="stylesheet" href="{{ ASSET_URL }}">
  {% endassets %}

  {# D3.js #}
  {# <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> #}
  <script src="/static/thirdparty/d3.v3.min.js" charset="utf-8"></script>

  {# Bootstrap multiselect #}
  <script type="text/javascript" src="/static/thirdparty/bootstrap-multiselect/bootstrap-multiselect.js"></script>
  <link rel="stylesheet" href="/static/thirdparty/bootstrap-multiselect/bootstrap-multiselect.css" type="text/css"/>

  {# Nunjucks templates #}
  {% if is_debug_mode %}
    <script type="text/javascript" src="/static/thirdparty/nunjucks.js"></script>
  {% else %}
    <script type="text/javascript" src="/static/thirdparty/nunjucks-slim.min.js"></script>
    <script type="text/javascript" src="/static/js_templates/precompiled/network.js"></script>
  {% endif %}

  {# Clipboard #}
  <script type="text/javascript"  src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.15/clipboard.min.js"></script>

{% endblock %}


{% block breadcrumb %}
  {{ super() }}
  <li><a href="{{ url_for('ProteinView:index') }}">Proteins</a></li>
  <li><a href="{{ url_for('GeneView:show', gene_name=protein.gene.name) }}">{{ protein.gene.name }}</a></li>
  <li class="active">{{ protein.refseq }}</li>
{% endblock %}


{% block content %}

<h3>{{ protein.gene.name }} - {{ protein.refseq }}</h3>

  <div class="isoform-page-options">
    <ul class="nav nav-tabs">
      <li role="presentation">
        <a href="{{ url_for('ProteinView:show', refseq=protein.refseq, filters=filters.url_string()) }}">
          <span class="glyphicon glyphicon-indent-left" aria-hidden="true" style="transform:rotate(-90deg)"></span>
          Sequence View
        </a>
      <li role="presentation" class="active">
        <a href="#">
          <span class="glyphicon glyphicon-globe" aria-hidden="true"></span>
          Network view
        </a>
    </ul>
    <div class="actions">
      {% include 'buttons/short_url.html' %}
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">

      {# Legend #}
      <div class="panel panel-default color-legend">
        <div class="panel-heading">
          <h3 class="panel-title">Legend</h3>
        </div>
        <div class="panel-body">

          <div class="legend">
            <h4>Protein</h4>
            <div class="swatch">
              <div class="protein">
                <div class="color"></div>
              </div>
              <div class="name">Currently analysed protein</div>
            </div>
          </div>

          <div class="legend">
            <h4>Kinases</h4>
            <div class="swatch">
              <div class="kinase">
                <div class="color"></div>
              </div>
              <div class="name">Kinase interacting with one of sites</div>
            </div>
            <div class="swatch">
              <div class="kinase-gradient gradient">
                <div class="left-edge edge">0</div>
                <div class="color"></div>
                <div class="right-edge edge">max</div>
              </div>
              <div class="name">
                mutations occurring in this kinase
              </div>
            </div>
          </div>

          <div class="legend">
            <h4>Sites</h4>
            <div class="swatch">
              <div class="site">
                <div class="color"></div>
              </div>
              <div class="name">PTM Site</div>
              <div class="name">color corresponds to type</div>
            </div>
          </div>

        </div>
      </div>

      {# Filters #}
      <form method="GET" class="widget-form">
        {% include 'widgets/filters_box.html' %}

        <div class="collapse-me" tabindex="-1">
          {% with collapsed=True %}
            {% include 'widgets/options.html' %}
          {% endwith %}
        </div>

        <input type="hidden" name="fallback" value="True">
      </form>

      {# Contact us #}
      {% with feature='protein', title=protein.refseq %}
        {% include "contact_box.html" %}
      {% endwith %}

    </div>
    <div class="col-md-9">

      {# network #}
      <div class="panel panel-default panel-with-btn network">
          <div class="panel-heading">
            <div class="heading-left">
              <h3 class="panel-title">PTM Interaction Network Visualisation</h3>
            </div>
            <div class="heading-right">

              <div class="btn-group zooming" role="group">
                <button type="button" class="btn btn-default zoom-in" title="Zoom in">
                  <span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span>
                </button>
                <button type="button" class="btn btn-default zoom-fit" title="Fit to the window">
                  <span class="glyphicon glyphicon-screenshot" aria-hidden="true"></span> Fit window
                </button>
                <button type="button" class="btn btn-default zoom-out" title="Zoom out">
                  <span class="glyphicon glyphicon-zoom-out" aria-hidden="true"></span>
                </button>
              </div>

              {% include 'buttons/export.html' %}
            </div>
          </div>
          <div class="panel-body">
            <div id="network_spinner">
              <span class="glyphicon glyphicon-refresh glyphicon-spin"></span>
            </div>
            <div id="network_plot">
            </div>
          </div>
      </div>

      {# references #}
      {% include 'protein/external_references.html' %}

    </div>
  </div>

{% endblock %}


{% block footer_js %}
  <script type="text/javascript">
    $('#spinner').hide()
    $('#network_spinner').show()
  </script>


    {% assets "js_network_view" %}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}
    <script type="text/javascript">
    nunjucks.configure('/static/js_templates', {autoescape: true})

    var plot = document.getElementById('network_plot')

    Network.init({
        show_sites: {{ filters.get_value('JavaScript.show_sites') | lower }},
        clone_by_site: {{ filters.get_value('JavaScript.clone_by_site') | lower }},
        element: plot,
        data: "{{ url_for('NetworkView:representation', refseq=protein.refseq, filters=filters.url_string()) }}" {# {{ data | json | safe }} #},
        radius: 20,
        ratio: 0.5, /* remember to keep update with style of network */
        nodeURL: function(node){
            return '{{ url_for('ProteinView:show', refseq='') }}' + node.protein.refseq
        },
        onload: function(){ $('#network_spinner').hide() }
    })

    $('.zoom-in').on('click', Network.zoom_in)
    $('.zoom-out').on('click', Network.zoom_out)
    $('.zoom-fit').on('click', function(){Network.zoom_fit()})

    var collapse_it = $('.collapse-me')
    collapse_it.find('.panel-heading').on('click', function()
      {
        $(this).closest('.panel').find('.panel-body').toggleClass('js-hidden')
      }
    )

    ShortURL().init(
      "{{ url_for('ShortAddress:get_shorthand_for') }}",
      "{{ url_for('ShortAddress:visit_shorthand', shorthand='<shorthand>', _external=True) }}"
    )

    {% assets "css_network" %}
    Export.init(
        plot,
        'network_view:{{ protein.gene.name }}-{{ protein.refseq }}-{{ filters.url_string(expanded=True) }}',
        '{{ ASSET_URL }}'
    )
    {% endassets %}

  </script>
{% endblock %}
